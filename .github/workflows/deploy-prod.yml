name: Deploy React App

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  export-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    outputs:
      artifact_url: ${{ steps.generate_artifact.outputs.artifact_url }}
    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v3

      - name: üì¶ Instalar dependencias
        run: npm install

      - name: üìÑ Crear archivo .env desde los secretos
        run: |
          echo "VITE_API_BASE_URL=${{ secrets.REACT_APP_API_BASE_URL }}" >> .env
          echo "VITE_MEDIA_BASE_URL=${{ secrets.REACT_APP_MEDIA_BASE_URL }}" >> .env

      - name: ‚öôÔ∏è Construir la aplicaci√≥n
        run: npm run build
        
      - name: üóúÔ∏è Comprimir el build
        run: zip -r build.zip ./dist

      - name: üì§ Guardar el ZIP como artefacto
        uses: actions/upload-artifact@v4
        id: upload_artifact
        with:
          name: react-build
          path: build.zip

      - name: Generate Artifact URL
        id: generate_artifact
        run: echo "artifact_url=https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${{ steps.upload_artifact.outputs.artifact-id }}/zip" >> $GITHUB_OUTPUT

  deploy: 
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    needs: export-and-deploy
    steps:
      - name: üîß Conectar por SSH y desplegar
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            APP_DIR="/home/${{ secrets.SSH_USER }}/${{ secrets.APP_DIR }}"
            ARTIFACT_URL="${{ needs.export-and-deploy.outputs.artifact_url }}"
            TEMP_ZIP="${APP_DIR}/build.zip"

            echo "Creando o limpiando el directorio de la aplicaci√≥n..."
            mkdir -p "$APP_DIR"
            rm -rf "${APP_DIR:?}/*"

            echo "Descargando artefacto desde GitHub..."
            curl -L -o "$TEMP_ZIP" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "$ARTIFACT_URL"

            if [ ! -f "$TEMP_ZIP" ] || [ ! -s "$TEMP_ZIP" ]; then
              echo "Error: La descarga del artefacto fall√≥ o el archivo est√° vac√≠o."
              exit 1
            fi

            echo "Extrayendo artefacto en el directorio de la aplicaci√≥n..."
            unzip -o "$TEMP_ZIP" -d "$APP_DIR"

            echo "Limpiando el archivo ZIP temporal..."
            rm -f "$TEMP_ZIP"
            
            echo "¬°Despliegue finalizado con √©xito!"