name: Deploy React App QC

on:
  workflow_dispatch:
  pull_request:
    branches:
      - develop
  push:
    branches:
      - develop

jobs:
  export-and-deploy:
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      artifact_url: ${{ steps.generate_artifact.outputs.artifact_url }}
    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v3

      - name: üì¶ Instalar dependencias
        run: npm install

      - name: üìÑ Crear archivo .env desde los secretos
        run: |
          echo "VITE_API_BASE_URL=${{ secrets.REACT_APP_API_BASE_URL }}" >> .env
          echo "VITE_MEDIA_BASE_URL=${{ secrets.REACT_APP_MEDIA_BASE_URL }}" >> .env

      - name: ‚öôÔ∏è Construir la aplicaci√≥n
        run: npm run build
        
      - name: üóúÔ∏è Comprimir el build
        run: zip -r build.zip ./dist

      - name: üì§ Guardar el ZIP como artefacto
        uses: actions/upload-artifact@v4
        id: upload_artifact
        with:
          name: react-build
          path: build.zip

      - name: Generate Artifact URL
        id: generate_artifact
        run: echo "artifact_url=https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${{ steps.upload_artifact.outputs.artifact-id }}/zip" >> $GITHUB_OUTPUT

  deploy:
    runs-on: ubuntu-latest
    environment: dev
    needs: export-and-deploy
    steps:
      - name: 'üì• Descargar artefacto del build'
        uses: actions/download-artifact@v4
        with:
          name: react-build-${{ github.run_id }}
          path: .

      - name: 'üöÄ Subir artefacto al servidor por SCP'
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: "build.zip"
          target: "/home/${{ secrets.SSH_USER }}/${{ secrets.APP_DIR }}"

      - name: 'üîß Conectar por SSH y desplegar (con logging)'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            APP_DIR="/home/${{ secrets.SSH_USER }}/${{ secrets.APP_DIR }}"
            LOG_FILE="$APP_DIR/deployment_$(date '+%Y-%m-%d_%H-%M-%S').log"
            
            {
              echo "üöÄ Iniciando despliegue en $(date)"
              TEMP_ZIP="$APP_DIR/build.zip"

              echo "Verificando la integridad del artefacto subido..."
              if [ ! -f "$TEMP_ZIP" ] || ! unzip -t "$TEMP_ZIP" > /dev/null; then
                echo "Error: El artefacto no se subi√≥ correctamente o est√° corrupto. Despliegue abortado."
                exit 1
              fi
              
              echo "Limpiando directorio de la aplicaci√≥n..."
              find "$APP_DIR" -mindepth 1 ! -name "$(basename "$TEMP_ZIP")" -exec rm -rf {} +

              echo "Extrayendo artefacto en el directorio de la aplicaci√≥n..."
              unzip -o "$TEMP_ZIP" -d "$APP_DIR"
              
              echo "Moviendo los archivos del build al directorio ra√≠z..."
              mv "$APP_DIR/dist"/* "$APP_DIR"/
              rmdir "$APP_DIR/dist"

              echo "Limpiando el archivo ZIP..."
              rm -f "$TEMP_ZIP"
              
              echo "‚úÖ ¬°Despliegue finalizado con √©xito! en $(date)"
            
            } > "$LOG_FILE" 2>&1 || {
              echo "‚ùå Ocurri√≥ un error durante el despliegue. Revisa el log en el servidor: $LOG_FILE"
              exit 1
            }